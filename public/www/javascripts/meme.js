var memes = [
    {
        "name": "fwp",
        "img" : "1stwp.jpg",
        "desc": "first world problem"
    },{
        "name": "baby",
        "img" : "successbaby.jpg",
        "desc": "Success kid"
    },{
        "name": "bru",
        "img" : "impossibru.jpg",
        "message2" : "IMPOSSIBRU!",
        "desc": "(.../impossibru!)"
    },{
        "name": "yuno",
        "img" : "yuno.gif",
        "desc": "y u no/use this meme?!"
    },{
        "name": "goodguy",
        "img" : "goodguy.jpg",
        "desc": "sees you stuck with memes/doesn't make fun of you"
    },{
        "name": "man",
        "img" : "mostinteresting.jpg",
        "desc": "The most interesting man on Earth"
    },{
        "name": "simply",
        "img" : "onedoesnotsimply.jpg",
        "message1" : "One does not simply",
        "desc": "Boromir (one does not simply/...)"
    },{
        "name": "whatif",
        "img" : "morpheus.jpg",
        "message1" : "What if I told you",
        "desc": "(what if I told you/...)"
    },{
        "name": "scumg",
        "img" : "stacy.jpg",
        "desc": "Scumgirl Stacy"
    },{
        "name": "scumb",
        "img" : "steve.jpg",
        "desc": "Scumbbag Steve"
    },{
        "name": "gf",
        "img" : "overly_attached.jpg",
        "desc": " I'm the only overly attached girlfriend/you will ever have. Ever."
    },{
        "name": "451",
        "img" : "451.jpg",
        "desc": "Silver Meikar"
    },{
        "name": "fuckme",
        "img" : "fuckme.jpg",
        "message2" : "fuck me, right?",
        "desc": "(.../fuck me, right?)"
    },{
        "name": "fa",
        "img" : "fa.jpg",
        "desc": "The infamous Forevel Alone"
    },{
        "name": "nobody",
        "img" : "aintnobody.jpg",
        "message2" : "Ain't nobody got time for that!",
        "desc": "(.../ain't nobody got time for that!)"
    },{
        "name": "boat",
        "img" : "boat.jpg",
        "desc": "The Contemplative Cat"
    },{
        "name": "science",
        "img" : "science.jpg",
        "message1" : "yeah!",
        "message2" : "science, bitch!",
        "desc": "Breaking Bad (yeah!/science, bitch!)"
    },{
        "name": "acc",
        "img" : "challengeaccepted.gif",
        "message1" : "challenge accepted",
        "desc": "Challenge accepted"
    },{
        "name": "default",
        "img" : "noSuchMeme.gif",
    },{
        "name": "jorpa",
        "img" : "jorpa.png",
        "desc": "Üllar Jörberg"
    },{
        "name": "yoda",
        "img" : "yoda.jpg",
        "desc": "no words needed/there are"
    },{
        "name": "doge",
        "img" : "doge.jpg",
        "desc": "Such meme. Many laugh. Wow."
    },{
        "name": "nohomo",
        "img" : "nohomo.jpg",
        "desc": "No homo"
    },{
        "name": "notbad",
        "img" : "notbad.jpg",
        "message2" : "not bad",
        "desc": "Obama is impressed (.../not bad)"
    },{
        "name": "what",
        "img" : "what.jpg",
        "message1" : "what?",
        "desc": "Seriously, WHAT are you looking at? (what?/...)"
    },{
        "name": "soclose",
        "img" : "soclose.gif",
        "desc": "Freddie Mercury is so close!"
    },{
        "name": "you",
        "img" : "you.jpg",
        "desc": "You, yeah, you! You're awesome!"
    },{
        "name": "africa",
        "img" : "africa.jpg",
        "message1" : "so you're telling me",
        "desc": "Third World sceptical kid (so you're telling me/...)"
    },{
        "name": "aliens",
        "img" : "aliens.jpg",
        "message1" : "Aliens",
        "desc": "(aliens/...)"
    },{
        "name": "live",
        "img" : "live.jpg",
        "message2" : "I also like to live dangerously",
        "desc": "Austin Powers also likes to live  dangerously (.../i also like to live dangerously)"

    },{
        "name": "brian",
        "img" : "brian.jpg",
        "desc": "Bad luck Brian"
    },{
        "name": "dawg",
        "img" : "dawg.jpg",
        "desc": "Yo, dawg, I heard you like to exhibit your inner Xzibit"
    },{
        "name": "wizard",
        "img" : "wizard.jpg",
        "desc": "This wizard will now download your software"
    },{
        "name": "high",
        "img" : "high.jpg",
        "message2" : "is too damn high",
        "desc": "the number of memes here/is too damn high (.../is too damn high)"
    },{
        "name": "isee",
        "img" : "isee.gif",
        "message2" : "i see what you did there",
        "desc": "(.../i see what you did there)"
    },{
        "name": "notsure",
        "img" : "notsure.jpg",
        "desc": "Fry is not sure/if you should use this meme"
    },{
        "name": "bean",
        "img" : "bean.png",
        "desc": "You can use me anytime/if you know what I mean (.../if you know what i mean)"
    },{
        "name": "stoned",
        "img" : "stoned.png",
        "desc": "The stoned guy"
    },{
        "name": "gusta",
        "img" : "gusta.png",
        "desc": "Me-gusta-face"
    },{
        "name": "parrot",
        "img" : "parrot.jpg",
        "desc": "Paranoid parrot. blanket not covering foot/foot not safe"
    },{
        "name": "social",
        "img" : "social.jpg",
        "desc": "Socially awkward penguin. Tries to hold back a burp/farts instead"
    },{
        "name": "say",
        "img" : "say.png",
        "desc": "Sarcastic Nicholas Cage (you don't say?/...)"
    },{
        "name": "kidding",
        "img" : "kidding.jpg",
        "desc": "Are you fucking kidding me?"
    },{
        "name": "smth",
        "img" : "smth.jpg",
        "desc": "Hey, it's something!..."
    },{
        "name": "story",
        "img" : "story.png",
        "desc": "Barney swears it's true story, bro"
    },{
        "name": "yeah",
        "img" : "yeah.jpg",
        "desc": "Aaaaaawwwww yeaaaahhhh!"
    },{
        "name": "please",
        "img" : "please.png",
        "desc": "You think you have all those memes memorized? Bitch please!"
    },{
        "name": "evil",
        "img" : "evil.jpg",
        "desc": "I dare you/to give me 1 million dollars"
    },{
        "name": "evil2",
        "img" : "evil2.gif",
        "desc": "I want this money/to ''make love, not war''"
    },{
        "name": "eyes",
        "img" : "eyes.jpg",
        "desc": "Really seductive eyes for all you lonely hearts out here"
    },{
        "name": "martin",
        "img" : "martin.jpg",
        "desc": "The unnaturally happy CEO"
    },{
        "name": "fu",
        "img" : "fu.gif",
        "desc": "Straight up middle finger in your face"
    },{
        "name": "sauli",
        "img" : "sauli.jpg",
        "desc": "The amazing Finn"
    },{
        "name": "sparta",
        "img" : "sparta.jpg",
        "desc": "THIS! IS! the Sparta meme"
    },{
        "name": "merka1",
        "img" : "merka1.jpg",
        "desc": "The community manager is sceptical"
    },{
        "name": "merka2",
        "img" : "merka2.jpg",
        "desc": "The community manager gets it"
    },{
        "name": "malev",
        "img" : "malev.jpg",
        "desc": "A typical Estonian"
    },{
        "name": "grumpy",
        "img" : "grumpy.jpg",
        "desc": "You hate our memes?/good."
    },{
        "name": "parts",
        "img" : "parts.jpg",
        "desc": "Juhan Parts"
    },{
        "name": "manly",
        "img" : "manly.jpg",
        "desc": "The overly manly man"
    },{
        "name": "stop",
        "img" : "stop.png",
        "desc": "Oh, stop it, you!"
    },{
        "name": "badass",
        "img" : "badass.jpg",
        "desc": "Watch out guys, we're dealing with a badass over here"
    },{
        "name": "90",
        "img" : "90.jpg",
        "desc": "Sad 90s. i want to surf the internet/but my mom is waiting for a call"
    },{
        "name": "ojuland",
        "img" : "ojuland.jpg",
        "desc": "Kristiina Ojuland"
    },{
        "name": "all",
        "img" : "all.jpg",
        "desc": "'Clean all the house!' meme"
    },{
        "name": "cleese",
        "img" : "cleese.png",
        "desc": "A surprised John Cleese"
    },{
        "name": "cleese2",
        "img" : "cleese2.png",
        "desc": "A very surprised John Cleese"
    },{
        "name": "joker",
        "img" : "joker.png",
        "desc": "Why such long/meme-list?"
    },{
        "name": "biz",
        "img" : "biz.png",
        "desc": "The business baby in action. three more bites/and we're so done with this porridge"
    },{
        "name": "sten",
        "img" : "sten.jpg",
        "desc": "why Sten? Because why not!"
    },{
        "name": "martin2",
        "img" : "martin2.jpg",
        "desc": "git push aww phat?"
    },{
        "name": "priority",
        "img" : "priority.jpg",
        "desc": "The ladies came for tan, but Priority Peter will teach them sin."
    },{
        "name": "freud",
        "img" : "freud.png",
        "desc": "You don't like bananas?/What about your dad?"
    },{
        "name": "mog",
        "img" : "mog.jpg",
        "desc": "(.../mother of god)"
    },{
        "name": "punked",
        "img" : "punked.jpg",
        "desc": "You've been punked by Mila Kunis's future husband!"
    },{
        "name": "valmiermuiza",
        "img" : "valmiermuiza.jpg",
        "desc": "You've been punked by Mila Kunis's future husband!"
    },{
        "name": "evil3",
        "img" : "evil3.png",
        "desc": "Evil and his minions laughing"
    },{
        "name": "tulnukas",
        "img" : "tulnukas.jpg",
        "desc": "no tee mis tahad"
    },{
        "name": "sasha2",
        "img" : "sasha2.jpg",
        "desc": "Sasha and the cats"
    },{
        "name": "boss",
        "img" : "boss.png",
        "desc": "Like a boss"
    },{
        "name": "no1",
        "img" : "no1.jpg",
        "desc": "No!"
    },{
        "name": "no2",
        "img" : "no2.jpg",
        "desc": "No again!"
    },{
        "name": "nool",
        "img" : "nool.jpg",
        "desc": "Estonian champion athlete Erki Nool. Also a fighter against homosexuality."
    },{
        "name": "saskia",
        "img" : "saskia.jpg",
        "desc": "Meet Saskia."
    },{
        "name": "sherif",
        "img" : "sherif.png",
        "desc": "Meet Sherif."
    },{
        "name": "pegasus",
        "img" : "pegasus.png",
        "desc": "Meet Pegasus."
    },{
        "name": "selfie",
        "img" : "selfie.jpg",
        "desc": "A selfish selfie."
    },{
        "name": "no",
        "img" : "no.jpg",
        "desc": "No!"
    },{
        "name": "np1",
        "img" : "np1.jpg",
        "desc": "#nullpunkt 1"
    },{
        "name": "np2",
        "img" : "np2.jpg",
        "desc": "#nullpunkt 2"
    },{
        "name": "np3",
        "img" : "np3.jpg",
        "desc": "#nullpunkt 3"
    },{
        "name": "np4",
        "img" : "np4.jpg",
        "desc": "#nullpunkt 4"
    },{
        "name": "np5",
        "img" : "np5.jpg",
        "desc": "#nullpunkt 5"
    },{
        "name": "np6",
        "img" : "np6.jpg",
        "desc": "#nullpunkt 6"
    },{
        "name": "np7",
        "img" : "np7.jpg",
        "desc": "#nullpunkt 7"
    },{
        "name": "sasha",
        "img" : "sasha.jpg",
        "desc": "Sasha Baron approves this message."
    },{
        "name": "joonatan1",
        "img" : "joonatan1.jpg",
        "desc": "Joonatan 1"
    },{
        "name": "joonatan2",
        "img" : "joonatan2.jpg",
        "desc": "Joonatan 2"
    },{
        "name": "cowboy1",
        "img" : "cowboy1.jpg",
        "desc": "As cowboy as Clint Eastwood can be"
    },{
        "name": "cowboy2",
        "img" : "cowboy2.png",
        "desc": "Not satisfied with cowboy1? Try cowboy2 with more background"
    }
]

function findMemeError(input) {
    var findMeme = /^m /;
    if(findMeme.test(input)) { // it's a meme
        processMessage = getMemeName(input);
        var memeName = processMessage['memeName'];
        var localMemes = new Array();
        var i = 0;
        $.each(window.memes, function(key, value) {
            localMemes[i] = value.name;
            i++;
        });
        var memeIndex = $.inArray(memeName, localMemes);
        if (memeIndex === -1) { // it's a meme with a typo
            justInput = "error";
            return justInput;
        }
    }
    else { // it ain't no meme
        return "noMeme";
    }
}


// takes meme message and slices & returns meme name
function getMemeName(message) {
    message = message.slice(2); // remove "m " from beginning

    if(message.indexOf(" ") != -1) var memeName = message.slice(0, message.indexOf(" ")); // get the meme name (if the text fields are not empty)

    message = message.slice(message.indexOf(" ")+1); // remove the meme name
    if(memeName === undefined) var memeName = message; // that's in case "m fwp", but messes up "m fwp tere".

    var processedMessage = new Array();
    processedMessage['memeName'] = memeName;
    processedMessage['message'] = message;
    return processedMessage;
}



function memeIt(data) {

    var Username = angular.injector(['ng', 'multiverse']).get("User");

    var rndNumb=Math.floor(Math.random()*1000000)
    var memeId = "meme"+rndNumb;

    var avatar = getAvatar(data.author);
    $("#isWriting").remove();
//cl(data);
    //$("#jetzt").before("<div class='message'><p><canvas id='"+memeId+"' class='full'></canvas></p></div>");
    $("#jetzt").before('<div class="message" id="'+data.nid+'"><img src="images/users/'+avatar+'" class="avatar" /><div class="time"><a class="gray" href="#/p/'+data.nid+'">'+data.time+'</a></div><div class="place small">'+data.city+'</div><p class="name"><strong>'+data.author+'</strong>&nbsp;&nbsp;<a class="gray nodecoration" href="#/r/'+data.room+'">#'+data.room+'</a></p><p><canvas id='+memeId+' class="full"></canvas><span class="viewers gray small"><span class="tick hidden">&nbsp;&nbsp;&#10003;</span></span></p></div>');

    socket.emit('nsa', { nid: data.nid, name: Username.get(), room: data.room });

    var message = data.title;


    var processedMessage = getMemeName(message);
    message = processedMessage['message'];
    memeName = processedMessage['memeName'];

    var split = message.indexOf("/"); // find the position of "/" mark

    var message1 = '';
    var message2 = '';

    if (split === -1) { // not a 2 lined meme
        if(message === memeName) { // not even a 1 lined meme
        } else {
             message1 = message.trim(); // it's a 1 lined meme
        }
    } else { // 2 lined meme
        message1 = message.slice(0, split).trim();
        message2 = message.slice(split+1).trim();
    }
    //var memeImg = "noSuchMeme.gif";
    $.each(memes, function(key, value) {
        if(memeName === value.name) {
            memeImg = value.img;
            //console.log(value.message1);
            memeDefaultMessage1 = value.message1 || '';
            memeDefaultMessage2 = value.message2 || '';

            if(message1 === '') message1 = memeDefaultMessage1;
            if(message2 === '') message2 = memeDefaultMessage2;
        }
    });

    //cl(message1);
    //cl(message2);

    //$("#jetzt").before("<div class='message'><p><canvas id='meme' class='full'></canvas></p></div>");

    var canvas = document.getElementById(memeId);
    //if(canvas != null) {
      var context = canvas.getContext('2d');

      var imageObj = new Image();

      imageObj.onload = function() {
          var memeWidth = this.width;
          var memeHeight = this.height;
          canvas.width  = memeWidth;
          canvas.height = memeHeight;
          //context.drawImage(imageObj, 0, 0, memeWidth, memeHeight);
          context.drawImage(imageObj, 0, 0);
          drawText(message1, message2, data.name); // <----
          var img    = canvas.toDataURL("image/png");
          //$("#jetzt").before('<div class="message"><img src="images/drm.jpg" class="avatar" /><div class="time">'+data.time+'</div><p class="name"><strong>'+data.author+'</strong></p><p><img class="full" src="'+img+'" /></p></div>');
          //window.scroll();
          //setTimeout( scroll(), 1000 );


      };

    imageObj.src = "images/meme/"+memeImg;

  //}


    function drawText( message1, message2, username ){
        message1 = message1.toUpperCase();
        message2 = message2.toUpperCase();


        context.font = '32pt Impact';
        context.textAlign = 'center';
        context.fillStyle = 'rgba(255, 255, 255, 1)';
        context.lineWidth = 2;
        context.strokeStyle = '#000000';

        // cut message1 to multiple lines if it's too long
        if(message1.length < 20) {
            context.fillText(message1, canvas.width/2, 55);
            context.strokeText(message1, canvas.width/2, 55);
        }
        else if(message1.length > 20 && message1.length < 40) {
            var m1cut1= message1.lastIndexOf(' ',20);
            var m1line1 = message1.substring(0, m1cut1);
            var m1line2 = message1.substring(m1cut1);
            context.fillText(m1line1, canvas.width/2, 55);
            context.strokeText(m1line1, canvas.width/2, 55);
            context.fillText(m1line2, canvas.width/2, 105);
            context.strokeText(m1line2, canvas.width/2, 105);
        }
        else {
            var m1cut1= message1.lastIndexOf(' ',20);
            var m1cut2= message1.lastIndexOf(' ',40);
            var m1line1 = message1.substring(0, m1cut1);
            var m1line2 = message1.substring(m1cut1, m1cut2);
            var m1line3 = message1.substring(m1cut2);
            context.fillText(m1line1, canvas.width/2, 55);
            context.strokeText(m1line1, canvas.width/2, 55);
            context.fillText(m1line2, canvas.width/2, 105);
            context.strokeText(m1line2, canvas.width/2, 105);
            context.fillText(m1line3, canvas.width/2, 155);
            context.strokeText(m1line3, canvas.width/2, 155);
        }

        // cut message 2 to multiple lines if it's too long
        if(message2.length < 20) {
            context.fillText(message2, canvas.width/2, canvas.height-25);
            context.strokeText(message2, canvas.width/2, canvas.height-25);
        }
        else if(message2.length > 20 && message2.length < 40) {
            var m2cut1= message2.lastIndexOf(' ',20);
            var m2line1 = message2.substring(0, m2cut1);
            var m2line2 = message2.substring(m2cut1);
            context.fillText(m2line1, canvas.width/2, canvas.height-75);
            context.strokeText(m2line1, canvas.width/2, canvas.height-75);
            context.fillText(m2line2, canvas.width/2, canvas.height-25);
            context.strokeText(m2line2, canvas.width/2, canvas.height-25);
        }
        else {
            var m2cut1= message2.lastIndexOf(' ',20);
            var m2cut2= message2.lastIndexOf(' ',40);
            var m2line1 = message2.substring(0, m2cut1);
            var m2line2 = message2.substring(m2cut1, m2cut2);
            var m2line3 = message2.substring(m2cut2);
            context.fillText(m2line1, canvas.width/2, canvas.height-125);
            context.strokeText(m2line1, canvas.width/2, canvas.height-125);
            context.fillText(m2line2, canvas.width/2, canvas.height-75);
            context.strokeText(m2line2, canvas.width/2, canvas.height-75);
            context.fillText(m2line3, canvas.width/2, canvas.height-25);
            context.strokeText(m2line3, canvas.width/2, canvas.height-25);
        }

        //window.scroll();
    }
}
